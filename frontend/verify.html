<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoPath Verification</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="verification-box">
            <h1>Welcome to AlgoPath!</h1>
            <p>Please verify your account to access all channels.</p>
            
            <form id="verificationForm">
                <div class="form-group">
                    <label for="username">Discord Username:</label>
                    <input type="text" id="username" readonly>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address:</label>
                    <input type="email" id="email" required placeholder="Enter your email">
                </div>
                
                <div class="form-group" id="otpGroup" style="display: none;">
                    <label for="otp">OTP:</label>
                    <input type="text" id="otp" placeholder="Enter OTP from your email">
                </div>
                
                <button type="submit" id="submitBtn">Send OTP</button>
            </form>
            
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        // Get username from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        
        if (username) {
            document.getElementById('username').value = username;
        } else {
            document.getElementById('message').textContent = 'Invalid verification link. Please use the link from the welcome message.';
            document.getElementById('message').className = 'message error';
            document.getElementById('verificationForm').style.display = 'none';
        }

        const form = document.getElementById('verificationForm');
        const otpGroup = document.getElementById('otpGroup');
        const submitBtn = document.getElementById('submitBtn');
        const messageDiv = document.getElementById('message');
        let isOtpSent = false;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const otp = document.getElementById('otp').value;

            try {
                if (!isOtpSent) {
                    // Send OTP
                    const response = await fetch('/api/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email,
                            discordId: username
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        messageDiv.textContent = 'OTP sent to your email! Please check your inbox.';
                        messageDiv.className = 'message success';
                        otpGroup.style.display = 'block';
                        submitBtn.textContent = 'Verify OTP';
                        isOtpSent = true;
                    } else {
                        messageDiv.textContent = data.message;
                        messageDiv.className = 'message error';
                    }
                } else {
                    // Verify OTP
                    const response = await fetch('/api/verify-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email,
                            discordId: username,
                            otp
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        messageDiv.textContent = 'Verification successful! You can now close this window and return to Discord.';
                        messageDiv.className = 'message success';
                        form.style.display = 'none';
                    } else {
                        messageDiv.textContent = data.message;
                        messageDiv.className = 'message error';
                    }
                }
            } catch (error) {
                messageDiv.textContent = 'An error occurred. Please try again.';
                messageDiv.className = 'message error';
            }
        });
    </script>
</body>
</html> 